* Org Tasks Web v1: Backend Plan, API Contract, and Data Schema
:PROPERTIES:
:CUSTOM_ID: org-tasks-web-v1-backend-plan-api-contract-and-data-schema
:END:
Date: 2026-02-12 Status: Draft v1

** 1) Decision and Step Log
:PROPERTIES:
:CUSTOM_ID: 1-decision-and-step-log
:END:
- [X] Confirmed web v1 must support iPhone usage (quick add + view
  notes/tasks).
- [X] Confirmed future iOS app will be native iOS (Swift/SwiftUI), not
  React Native.
- [X] Confirmed =file-as-project= is the default project model.
- [X] Decided not to use CloudKit for this project.
- [X] Chosen backend approach: Django + PostgreSQL + object storage.
- [X] Chosen auth approach from day 1: =django-allauth= with social
  auth.
- [X] Locked social providers for v1: Apple and Google.
- [X] Updated web frontend choice to Vue.js (replace previous React
  direction).
- [X] Drafted concrete endpoint contract (below).
- [X] Drafted concrete data schema (below).
- [X] Added Vue app shell scaffold (=web/=) with router, vue-query, and
  PWA wiring.
- [X] Scaffolded Django backend via cookiecutter in =todo_lisp/= (Docker
  + DRF + allauth baseline).
- [X] Wired allauth Apple/Google providers in settings and added
  =sync_social_apps= env bootstrap command.
- [X] Added =PyJWT= dependency required by allauth Apple provider.
- [X] Next: commit first migration set.
- [ ] Next: implement auth/session endpoints.
- [ ] Next: implement =quick-add= and =tasks list= endpoints.
- [ ] redesign the login screen with proper google / apple logos

** 2) v1 Backend Scope
:PROPERTIES:
:CUSTOM_ID: 2-v1-backend-scope
:END:
Backend responsibilities:

- Authentication and user sessions.
- Workspace ownership and settings.
- Org file versioning and minimal-diff write pipeline.
- Task/query APIs for Inbox, Today, Upcoming, Filters, Projects, Labels,
  Search.
- Conflict detection and preservation using =conflicts.org= semantics.

Out of scope for v1 backend:

- Real-time multi-user collaboration and presence.
- Mentions/comments/permissions beyond owner-only model.
- Complex CRDT or operation-stream sync.

** 3) Stack and Auth Baseline
:PROPERTIES:
:CUSTOM_ID: 3-stack-and-auth-baseline
:END:
** 3.1 Core stack
:PROPERTIES:
:CUSTOM_ID: 31-core-stack
:END:
- Django 5.x
- Django REST Framework
- django-allauth
- PostgreSQL 15+
- Object storage abstraction (local disk in dev, S3-compatible in prod)

** 3.2 Auth baseline
:PROPERTIES:
:CUSTOM_ID: 32-auth-baseline
:END:
- Auth type: server session cookie (=HttpOnly=, =Secure=,
  =SameSite=Lax=).
- CSRF required for all state-changing requests (=X-CSRFToken=).
- Frontend and API served from same site to avoid iOS cookie edge cases.
- Social providers enabled at launch:
  - Google OAuth2
  - Sign in with Apple
- Email/password login can stay enabled for admin/testing, but social
  auth is first-class.

** 3.3 allauth routes (server-owned)
:PROPERTIES:
:CUSTOM_ID: 33-allauth-routes-server-owned
:END:
- =GET /accounts/google/login/=
- =GET /accounts/apple/login/=
- =GET /accounts/logout/=
- Callback routes handled by allauth provider integrations.

The app frontend should redirect to these routes for login initiation
and return to app URLs with =next==.

** 4) API Conventions
:PROPERTIES:
:CUSTOM_ID: 4-api-conventions
:END:
- Base path: =/api/v1=
- Content type: =application/json=
- Time format: ISO 8601 UTC (=2026-02-12T18:20:00Z=)
- IDs: UUID strings unless explicitly noted.
- Pagination: cursor-based (=limit=, =cursor=)
- Idempotency for create-like actions: =Idempotency-Key= header.

Standard error envelope:

#+begin_src json
{
  "error": {
    "code": "node_conflict",
    "message": "Task was changed by another edit.",
    "details": {}
  }
}
#+end_src

** 5) Endpoint Contract
:PROPERTIES:
:CUSTOM_ID: 5-endpoint-contract
:END:
** 5.1 Auth and Session
:PROPERTIES:
:CUSTOM_ID: 51-auth-and-session
:END:
*** GET =/api/v1/auth/session=
:PROPERTIES:
:CUSTOM_ID: get-apiv1authsession
:END:
Returns signed-in user info and CSRF bootstrap state.

Response =200=:

#+begin_src json
{
  "authenticated": true,
  "user": {
    "id": "4d8c4f26-3e75-47e2-9dbe-162ba0cd6a3d",
    "email": "user@example.com",
    "name": "Example User"
  },
  "providers": ["google", "apple"],
  "csrf_token": "M1k6aR..."
}
#+end_src

Response =200= (anonymous):

#+begin_src json
{
  "authenticated": false,
  "providers": ["google"],
  "csrf_token": "M1k6aR..."
}
#+end_src

*** GET =/api/v1/auth/providers=
:PROPERTIES:
:CUSTOM_ID: get-apiv1authproviders
:END:
Returns login URLs for UI buttons.

Optional query param:
- =next=: local absolute path redirect after login. Defaults to =/inbox=.

Response =200=:

#+begin_src json
{
  "google_login_url": "/accounts/google/login/?process=login&next=/inbox",
  "apple_login_url": null
}
#+end_src

*** POST =/api/v1/auth/logout=
:PROPERTIES:
:CUSTOM_ID: post-apiv1authlogout
:END:
Ends current session.

Behavior:
- Authenticated session requires valid CSRF header (=X-CSRFToken=).
- Anonymous calls are idempotent and still return =204=.

Response =204=.

** 5.2 Workspaces
:PROPERTIES:
:CUSTOM_ID: 52-workspaces
:END:
*** GET =/api/v1/workspaces=
:PROPERTIES:
:CUSTOM_ID: get-apiv1workspaces
:END:
Lists workspaces for current user (owner-only in v1).

*** POST =/api/v1/workspaces=
:PROPERTIES:
:CUSTOM_ID: post-apiv1workspaces
:END:
Creates workspace.

Request:

#+begin_src json
{
  "name": "Personal",
  "timezone": "America/Los_Angeles",
  "default_capture_file": "inbox.org",
  "default_capture_heading": "Inbox",
  "todo_keywords": ["TODO", "NEXT", "WAIT", "DONE", "CANCELLED"],
  "include_patterns": ["**/*.org"],
  "exclude_patterns": [".git/**", "archive/**"]
}
#+end_src

Response =201=:

#+begin_src json
{
  "id": "f7d7d57a-cbb7-4b34-a1dd-6e6658f26193",
  "name": "Personal"
}
#+end_src

*** GET =/api/v1/workspaces/{workspace_id}=
:PROPERTIES:
:CUSTOM_ID: get-apiv1workspacesworkspace_id
:END:
Returns settings and summary counts.

*** PATCH =/api/v1/workspaces/{workspace_id}=
:PROPERTIES:
:CUSTOM_ID: patch-apiv1workspacesworkspace_id
:END:
Updates settings (=todo_keywords=, capture target, timezone,
include/exclude patterns).

** 5.3 Projects, Labels, and Filters
:PROPERTIES:
:CUSTOM_ID: 53-projects-labels-and-filters
:END:
*** GET =/api/v1/workspaces/{workspace_id}/projects=
:PROPERTIES:
:CUSTOM_ID: get-apiv1workspacesworkspace_idprojects
:END:
Returns file-as-project list and optional heading-level projects
(=APP_PROJECT=t=).

*** GET =/api/v1/workspaces/{workspace_id}/labels=
:PROPERTIES:
:CUSTOM_ID: get-apiv1workspacesworkspace_idlabels
:END:
Returns distinct tags with counts.

*** GET =/api/v1/filters?workspace_id={workspace_id}=
:PROPERTIES:
:CUSTOM_ID: get-apiv1filtersworkspace_idworkspace_id
:END:
*** POST =/api/v1/filters=
:PROPERTIES:
:CUSTOM_ID: post-apiv1filters
:END:
*** PATCH =/api/v1/filters/{filter_id}=
:PROPERTIES:
:CUSTOM_ID: patch-apiv1filtersfilter_id
:END:
*** DELETE =/api/v1/filters/{filter_id}=
:PROPERTIES:
:CUSTOM_ID: delete-apiv1filtersfilter_id
:END:
Saved filter CRUD.

Filter create request:

#+begin_src json
{
  "workspace_id": "f7d7d57a-cbb7-4b34-a1dd-6e6658f26193",
  "name": "Deep Work",
  "query": "todo != DONE and (tag = focus or priority = A)"
}
#+end_src

** 5.4 Tasks
:PROPERTIES:
:CUSTOM_ID: 54-tasks
:END:
*** GET =/api/v1/tasks=
:PROPERTIES:
:CUSTOM_ID: get-apiv1tasks
:END:
Query params:

- =workspace_id= (required)
- =view= = =inbox|today|upcoming|overdue|project|label|search|filter=
- =project= (path or project id)
- =label= (single tag)
- =q= (search query)
- =filter_id=
- =from= / =to= (date range for upcoming timeline)
- =limit= (default 50, max 200)
- =cursor=

Rules:

- =today=: scheduled today OR deadline today, excluding done states.
- =overdue=: deadline before today, excluding done.
- =upcoming=: scheduled/deadline in range.

Response =200=:

#+begin_src json
{
  "items": [
    {
      "node_id": "3f6a0d1e-3d5c-4b1b-9b5b-9d8b5b1c8c2a",
      "workspace_id": "f7d7d57a-cbb7-4b34-a1dd-6e6658f26193",
      "file_path": "inbox.org",
      "title": "Pay rent",
      "todo_state": "TODO",
      "priority": "A",
      "tags": ["finance"],
      "scheduled_raw": null,
      "deadline_raw": "<2026-03-01 Sun>",
      "scheduled_at": null,
      "deadline_at": "2026-03-01",
      "props": {
        "ID": "3f6a0d1e-3d5c-4b1b-9b5b-9d8b5b1c8c2a",
        "CREATED": "[2026-02-12 Thu 10:30]"
      },
      "is_task": true,
      "row_version": 4,
      "updated_at": "2026-02-12T18:20:00Z"
    }
  ],
  "next_cursor": null
}
#+end_src

*** POST =/api/v1/tasks/quick-add=
:PROPERTIES:
:CUSTOM_ID: post-apiv1tasksquick-add
:END:
Creates a task in capture target (=inbox.org= / =* Inbox= by default),
parsing inline hints.

Request:

#+begin_src json
{
  "workspace_id": "f7d7d57a-cbb7-4b34-a1dd-6e6658f26193",
  "input": "Pay rent tomorrow #finance p1",
  "target": {
    "file_path": "inbox.org",
    "heading": "Inbox"
  },
  "timezone": "America/Los_Angeles"
}
#+end_src

Response =201=:

#+begin_src json
{
  "task": {
    "node_id": "3f6a0d1e-3d5c-4b1b-9b5b-9d8b5b1c8c2a",
    "title": "Pay rent",
    "todo_state": "TODO",
    "tags": ["finance"],
    "priority": "A",
    "deadline_raw": "<2026-02-13 Fri>",
    "row_version": 1
  },
  "parse": {
    "recognized": ["tomorrow", "#finance", "p1"],
    "unparsed": []
  }
}
#+end_src

*** GET =/api/v1/tasks/{node_id}?workspace_id={workspace_id}=
:PROPERTIES:
:CUSTOM_ID: get-apiv1tasksnode_idworkspace_idworkspace_id
:END:
Returns full task details including body text and raw Org snippets
needed by editor.

*** PATCH =/api/v1/tasks/{node_id}=
:PROPERTIES:
:CUSTOM_ID: patch-apiv1tasksnode_id
:END:
Updates fields with optimistic concurrency.

Request:

#+begin_src json
{
  "workspace_id": "f7d7d57a-cbb7-4b34-a1dd-6e6658f26193",
  "base_row_version": 4,
  "changes": {
    "title": "Pay rent and utilities",
    "todo_state": "NEXT",
    "tags": ["finance", "home"],
    "scheduled_raw": "<2026-02-20 Fri>",
    "deadline_raw": "<2026-03-01 Sun>"
  }
}
#+end_src

Success response =200=:

#+begin_src json
{
  "task": {
    "node_id": "3f6a0d1e-3d5c-4b1b-9b5b-9d8b5b1c8c2a",
    "row_version": 5
  }
}
#+end_src

Conflict response =409=:

#+begin_src json
{
  "error": {
    "code": "node_conflict",
    "message": "Same field changed in another edit.",
    "details": {
      "conflict_id": "2b5306f9-34c4-4abd-8adf-7f89de8ef9f8",
      "conflicting_fields": ["title"]
    }
  }
}
#+end_src

*** POST =/api/v1/tasks/{node_id}/move=
:PROPERTIES:
:CUSTOM_ID: post-apiv1tasksnode_idmove
:END:
Moves subtree to file/heading.

Request:

#+begin_src json
{
  "workspace_id": "f7d7d57a-cbb7-4b34-a1dd-6e6658f26193",
  "base_row_version": 5,
  "target": {
    "file_path": "projects/home.org",
    "parent_node_id": "2c8a6407-932f-46ab-9463-b0e9d65b29f7",
    "position": "end"
  }
}
#+end_src

*** POST =/api/v1/tasks/{node_id}/reorder=
:PROPERTIES:
:CUSTOM_ID: post-apiv1tasksnode_idreorder
:END:
Reorders task under same parent.

Request:

#+begin_src json
{
  "workspace_id": "f7d7d57a-cbb7-4b34-a1dd-6e6658f26193",
  "base_row_version": 5,
  "new_order_in_parent": 2
}
#+end_src

*** POST =/api/v1/tasks/{node_id}/complete=
:PROPERTIES:
:CUSTOM_ID: post-apiv1tasksnode_idcomplete
:END:
Marks done and applies repeater policy.

Request:

#+begin_src json
{
  "workspace_id": "f7d7d57a-cbb7-4b34-a1dd-6e6658f26193",
  "base_row_version": 5,
  "behavior": "org_advance"
}
#+end_src

Response:

#+begin_src json
{
  "task": {
    "node_id": "3f6a0d1e-3d5c-4b1b-9b5b-9d8b5b1c8c2a",
    "todo_state": "TODO",
    "scheduled_raw": "<2026-02-27 Fri +1w>",
    "row_version": 6
  }
}
#+end_src

** 5.5 Conflicts
:PROPERTIES:
:CUSTOM_ID: 55-conflicts
:END:
*** GET =/api/v1/conflicts?workspace_id={workspace_id}&status=open=
:PROPERTIES:
:CUSTOM_ID: get-apiv1conflictsworkspace_idworkspace_idstatusopen
:END:
Returns unresolved conflicts for banner and review UI.

*** POST =/api/v1/conflicts/{conflict_id}/resolve=
:PROPERTIES:
:CUSTOM_ID: post-apiv1conflictsconflict_idresolve
:END:
Marks conflict resolved.

Request:

#+begin_src json
{
  "workspace_id": "f7d7d57a-cbb7-4b34-a1dd-6e6658f26193",
  "resolution": "kept_both"
}
#+end_src

** 5.6 Delta Sync for Clients
:PROPERTIES:
:CUSTOM_ID: 56-delta-sync-for-clients
:END:
*** GET =/api/v1/changes?workspace_id={workspace_id}&since_cursor={cursor}=
:PROPERTIES:
:CUSTOM_ID: get-apiv1changesworkspace_idworkspace_idsince_cursorcursor
:END:
Returns changed tasks/files/conflicts since last cursor for efficient
mobile refresh.

Response:

#+begin_src json
{
  "changes": [
    {
      "type": "task_updated",
      "node_id": "3f6a0d1e-3d5c-4b1b-9b5b-9d8b5b1c8c2a",
      "row_version": 6
    }
  ],
  "next_cursor": "2026-02-12T18:40:00.123456Z#8451"
}
#+end_src

** 6) Data Schema (Django + PostgreSQL)
:PROPERTIES:
:CUSTOM_ID: 6-data-schema-django--postgresql
:END:
Notes:

- Canonical task identity is Org =:ID:= mapped to =nodes.node_id=.
- Org files remain canonical content; database is
  index/state/history/conflict support.
- allauth tables are omitted below because they are provided by
  Django/allauth migrations.

** 6.1 =workspaces=
:PROPERTIES:
:CUSTOM_ID: 61-workspaces
:END:
- =id= UUID PK
- =owner_id= FK -> =auth_user.id= (indexed)
- =name= varchar(120)
- =slug= varchar(120)
- =timezone= varchar(64), default =UTC=
- =todo_keywords= jsonb
- =default_capture_file= varchar(512), default =inbox.org=
- =default_capture_heading= varchar(128), default =Inbox=
- =include_patterns= jsonb
- =exclude_patterns= jsonb
- =created_at= timestamptz
- =updated_at= timestamptz

Constraints/indexes:

- =UNIQUE(owner_id, slug)=

** 6.2 =workspace_memberships= (v2-ready, owner-only in v1)
:PROPERTIES:
:CUSTOM_ID: 62-workspace_memberships-v2-ready-owner-only-in-v1
:END:
- =id= UUID PK
- =workspace_id= FK -> =workspaces.id=
- =user_id= FK -> =auth_user.id=
- =role= varchar(16) (=owner=, =editor=, =viewer=)
- =status= varchar(16) (=active=, =invited=, =disabled=)
- =created_at= timestamptz

Constraints/indexes:

- =UNIQUE(workspace_id, user_id)=

** 6.3 =org_files=
:PROPERTIES:
:CUSTOM_ID: 63-org_files
:END:
- =id= UUID PK
- =workspace_id= FK -> =workspaces.id= (indexed)
- =path= varchar(1024)
- =latest_version= bigint, default =0=
- =latest_checksum= char(64)
- =latest_size_bytes= bigint
- =parse_hash= char(64), nullable
- =last_indexed_at= timestamptz, nullable
- =created_at= timestamptz
- =updated_at= timestamptz

Constraints/indexes:

- =UNIQUE(workspace_id, path)=
- index on =(workspace_id, updated_at desc)=

** 6.4 =org_file_versions=
:PROPERTIES:
:CUSTOM_ID: 64-org_file_versions
:END:
- =id= bigserial PK
- =workspace_id= FK -> =workspaces.id=
- =org_file_id= FK -> =org_files.id=
- =version= bigint
- =storage_key= varchar(1024)
- =checksum= char(64)
- =size_bytes= bigint
- =created_by_id= FK -> =auth_user.id=, nullable
- =source= varchar(16) (=api=, =import=, =sync=)
- =created_at= timestamptz

Constraints/indexes:

- =UNIQUE(org_file_id, version)=
- index on =(workspace_id, created_at desc)=

** 6.5 =nodes=
:PROPERTIES:
:CUSTOM_ID: 65-nodes
:END:
- =id= bigserial PK
- =workspace_id= FK -> =workspaces.id= (indexed)
- =node_id= UUID (Org =:ID:=)
- =org_file_id= FK -> =org_files.id=
- =parent_id= FK -> =nodes.id=, nullable
- =level= smallint
- =order_in_parent= int
- =outline_path= text
- =raw_heading= text
- =title= text
- =todo_state= varchar(24), nullable
- =priority= char(1), nullable
- =tags= text[]
- =scheduled_raw= text, nullable
- =deadline_raw= text, nullable
- =scheduled_at= date, nullable
- =deadline_at= date, nullable
- =repeater_raw= varchar(32), nullable
- =props_json= jsonb
- =body_text= text
- =is_task= boolean
- =is_deleted= boolean, default =false=
- =field_hashes= jsonb
- =row_version= bigint, default =1=
- =subtree_start_line= int, nullable
- =subtree_end_line= int, nullable
- =created_at= timestamptz
- =updated_at= timestamptz

Constraints/indexes:

- =UNIQUE(workspace_id, node_id)=
- =CHECK(priority in ('A','B','C') or priority is null)=
- index on =(workspace_id, todo_state)=
- index on =(workspace_id, deadline_at)=
- index on =(workspace_id, scheduled_at)=
- GIN index on =tags=

** 6.6 =node_revisions=
:PROPERTIES:
:CUSTOM_ID: 66-node_revisions
:END:
- =id= bigserial PK
- =workspace_id= FK -> =workspaces.id=
- =node_id= UUID
- =row_version= bigint
- =changed_fields= text[]
- =patch_json= jsonb
- =file_version_id= FK -> =org_file_versions.id=
- =changed_by_id= FK -> =auth_user.id=, nullable
- =created_at= timestamptz

Constraints/indexes:

- =UNIQUE(workspace_id, node_id, row_version)=
- index on =(workspace_id, created_at desc)=

** 6.7 =saved_filters=
:PROPERTIES:
:CUSTOM_ID: 67-saved_filters
:END:
- =id= UUID PK
- =workspace_id= FK -> =workspaces.id=
- =name= varchar(120)
- =query= text
- =position= int
- =created_at= timestamptz
- =updated_at= timestamptz

Constraints/indexes:

- =UNIQUE(workspace_id, name)=

** 6.8 =conflicts=
:PROPERTIES:
:CUSTOM_ID: 68-conflicts
:END:
- =id= UUID PK
- =workspace_id= FK -> =workspaces.id=
- =node_id= UUID
- =org_file_id= FK -> =org_files.id=
- =base_row_version= bigint, nullable
- =incoming_changes= jsonb
- =current_state= jsonb
- =conflicting_fields= text[]
- =losing_copy_node_id= UUID, nullable
- =status= varchar(16), default =open=
- =detected_at= timestamptz
- =resolved_at= timestamptz, nullable
- =resolved_by_id= FK -> =auth_user.id=, nullable

Constraints/indexes:

- index on =(workspace_id, status, detected_at desc)=
- index on =(workspace_id, node_id, status)=

** 6.9 =idempotency_keys=
:PROPERTIES:
:CUSTOM_ID: 69-idempotency_keys
:END:
- =id= bigserial PK
- =user_id= FK -> =auth_user.id=
- =key= varchar(128)
- =request_hash= char(64)
- =response_json= jsonb
- =created_at= timestamptz

Constraints/indexes:

- =UNIQUE(user_id, key)=

** 7) Conflict and Write Pipeline (Server)
:PROPERTIES:
:CUSTOM_ID: 7-conflict-and-write-pipeline-server
:END:
For state-changing task operations:

1. Validate session and workspace ownership.
2. Load =nodes= row and verify =base_row_version=.
3. If version mismatch, compare =changes= against latest =field_hashes=.
4. If fields are disjoint, auto-merge and continue.
5. If same field changed:
   - create =conflicts= row,
   - write losing version as new task under =conflicts.org= with
     =APP_CONFLICT_OF=<node_id>=,
   - return =409 node_conflict=.
6. Apply minimal subtree edit to Org text.
7. Write new file snapshot in =org_file_versions=.
8. Increment =org_files.latest_version=.
9. Re-index affected file into =nodes=.
10. Append =node_revisions= row.

** 8) Milestone Notes (M1 to M5)
:PROPERTIES:
:CUSTOM_ID: 8-milestone-notes-m1-to-m5
:END:
- M1: auth first (allauth, providers, session), workspace bootstrap,
  read endpoints.
- M2: quick add and task edits with optimistic concurrency.
- M3: filters/projects/labels and move/reorder APIs; keep mobile
  interactions lightweight.
- M4: recurrence behavior and full conflict pipeline to =conflicts.org=.
- M5: hardening, performance, acceptance criteria, iPhone web
  reliability testing.

** 9) Immediate Build Sequence
:PROPERTIES:
:CUSTOM_ID: 9-immediate-build-sequence
:END:
1. Django project setup with DRF + allauth + sites framework.
2. Configure Google and Apple providers in allauth admin/settings.
3. Create models in sections 6.1 to 6.9 and run first migrations.
4. Implement =/api/v1/auth/session= and workspace CRUD.
5. Implement =/api/v1/tasks= list and =/api/v1/tasks/quick-add=.
6. Implement =PATCH /tasks/{node_id}= with conflict checks.
7. Add integration tests for acceptance criteria paths.
